AWSTemplateFormatVersion: 2010-09-09
Description: {{ route53_stack_name }} VPN records

# NOTES:
#
# 1.    Cannot use a pure template
#       Unfortunately, we cannot use a pure template with inputs rather than Jinja2 variable interpolation
#       because there is no way to loop in a CloudFormation template
#       (because Amazon fucking hates you)
#
# 2.    Note the trailing dots
#       Route53 requires trailing dots for hostnames

Resources:

  NewtroyZone:
    Type: AWS::Route53::HostedZone
    Properties:
      # Note trailing dot
      Name: {{ vpn_domain }}.

  NewtroyZoneRecords:
    Type: AWS::Route53::RecordSetGroup

    Properties:
      HostedZoneId: !Ref NewtroyZone
      RecordSets:

        - Name: {{ newtroy_vpn_server_hostname }}.{{ vpn_domain }}.
          Type: A
          TTL: 300
          ResourceRecords:
            - {{ vpn_host_ip }}

{%for user in users %}

        - Name: {{ user }}.{{ vpn_domain }}.
          Type: A
          TTL: 300
          ResourceRecords:
            - {{ vpn_network | ipaddr(loop.index + 1) | ipaddr('address') }}

        - Name: {{ user }}.{{ vpn_domain }}.
          Type: AAAA
          TTL: 300
          ResourceRecords:
            - {{ vpn_network_ipv6 | ipaddr(loop.index + 1) | ipaddr('address') }}

{%endfor%}
